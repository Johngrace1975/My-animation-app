<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TweenCraft Ultra - Production Build</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --primary: #ff9f43; --purple: #9b59b6; --bg: #0a0a0a; --card: #1e1e1e; --red: #e74c3c; --blue: #3498db; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; }
        .active { display: flex; }

        /* HOME SCREEN */
        #home-screen { align-items: center; justify-content: center; padding: 20px; }
        .choice-card { background: var(--card); width: 90%; max-width: 400px; padding: 20px; border-radius: 20px; margin-bottom: 15px; cursor: pointer; border: 2px solid transparent; display: flex; align-items: center; gap: 15px; }
        .choice-card:hover { border-color: var(--purple); }
        .bg-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 90%; max-width: 400px; }
        .bg-item { background: var(--card); border-radius: 10px; overflow: hidden; height: 100px; cursor: pointer; position: relative; }
        .bg-item img { width: 100%; height: 100%; object-fit: cover; }

        /* STUDIO */
        #studio-screen { flex-direction: column; }
        .workspace { display: flex; flex-grow: 1; position: relative; }
        .sidebar { width: 65px; background: #141414; display: flex; flex-direction: column; align-items: center; padding-top: 15px; gap: 15px; border-right: 1px solid #333; }
        .tool-btn { width: 42px; height: 42px; background: #222; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; }
        
        /* CANVAS */
        #canvas-wrapper { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #111; }
        
        /* AUDIO BAR */
        .audio-controls { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 8px 15px; border-radius: 25px; display: flex; gap: 10px; border: 1px solid var(--purple); }
        .audio-input { background: transparent; border: none; color: white; width: 150px; outline: none; font-size: 12px; }

        /* TIMELINE */
        .bottom-ui { height: 80px; background: #181818; display: flex; align-items: center; padding: 0 15px; gap: 10px; border-top: 1px solid #333; }
        .frame-box { width: 65px; height: 45px; background: #333; border-radius: 6px; border: 2px solid transparent; flex-shrink: 0; cursor: pointer; }
        .frame-box.active { border-color: var(--primary); }

        /* PREVIEW */
        #preview-layer { position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index: 1000; display:none; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <h2 style="margin-bottom: 25px;">TweenCraft Ultra</h2>
        <div class="choice-card" onclick="startAI()">
            <div style="background: var(--purple); padding: 10px; border-radius: 12px;">‚ú®</div>
            <div><b>AI Video Creator</b><br><small>Let AI build your scene</small></div>
        </div>
        <p style="color: #666; font-size: 12px;">OR CHOOSE A SCENE</p>
        <div class="bg-grid">
            <div class="bg-item" onclick="startManual('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=600')"><img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=200"></div>
            <div class="bg-item" onclick="startManual('https://images.unsplash.com/photo-1497366216548-37526070297c?w=600')"><img src="https://images.unsplash.com/photo-1497366216548-37526070297c?w=200"></div>
        </div>
    </div>

    <div id="studio-screen" class="screen">
        <div class="workspace">
            <div class="sidebar">
                <div class="tool-btn" onclick="addFullBody()">üë¶</div>
                <div class="tool-btn" onclick="toggleMoods()">üé≠</div>
                <div class="tool-btn" onclick="location.reload()">üè†</div>
            </div>
            <div id="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
            <div class="audio-controls">
                <input type="text" id="script" class="audio-input" placeholder="Type AI script...">
                <button class="tool-btn" style="width:auto; padding:0 10px; font-size:12px; background:var(--purple);" onclick="runAI()">Speak</button>
                <button class="tool-btn" style="width:auto; padding:0 10px; font-size:12px; background:var(--red);" onclick="alert('Recording...')">Rec</button>
            </div>
        </div>
        <div class="bottom-ui">
            <button class="tool-btn" style="background:var(--blue); width:80px; font-size:12px;" onclick="playPreview()">‚ñ∂Ô∏è Play</button>
            <div id="timeline" style="display:flex; gap:10px; overflow-x:auto; flex-grow:1;">
                <div class="frame-box active" id="f-0" onclick="switchFrame(0)"></div>
            </div>
            <div class="tool-btn" style="background:var(--primary); border-radius:50%;" onclick="addFrame()">+</div>
        </div>
    </div>

    <div id="preview-layer">
        <canvas id="pCanvas"></canvas>
        <button class="tool-btn" style="margin-top:20px; width:120px; background:var(--red);" onclick="closePreview()">Close</button>
    </div>

    <script>
        const canvas = new fabric.Canvas('mainCanvas');
        const pCanvas = new fabric.StaticCanvas('pCanvas');
        let frames = [];
        let cur = 0;

        window.onload = () => {
            canvas.setDimensions({ width: 800, height: 450 });
            pCanvas.setDimensions({ width: 800, height: 450 });
            save();
        };

        function startAI() { startManual('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800'); setTimeout(() => { addFullBody(); runAI("Welcome!"); }, 500); }

        function startManual(url) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('studio-screen').classList.add('active');
            fabric.Image.fromURL(url, img => {
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), { scaleX: 800/img.width, scaleY: 450/img.height });
            }, { crossOrigin: 'anonymous' });
        }

        function save() { frames[cur] = JSON.stringify(canvas); }

        function addFrame() {
            save(); cur = frames.length;
            const f = document.createElement('div');
            f.className = 'frame-box'; f.id = `f-${cur}`; f.onclick = () => switchFrame(cur);
            document.getElementById('timeline').appendChild(f);
            switchFrame(cur);
        }

        function switchFrame(i) {
            save(); cur = i;
            document.querySelectorAll('.frame-box').forEach(b => b.classList.remove('active'));
            document.getElementById(`f-${i}`).classList.add('active');
            canvas.loadFromJSON(frames[i] || '{}', () => canvas.renderAll());
        }

        function addFullBody() {
            fabric.Image.fromURL('https://cdn-icons-png.flaticon.com/512/4333/4333609.png', img => {
                img.set({ scaleX: 0.4, scaleY: 0.4, left: 100, top: 450, originY: 'bottom' });
                canvas.add(img); save();
            }, { crossOrigin: 'anonymous' });
        }

        function runAI(custom) {
            const t = custom || document.getElementById('script').value;
            const msg = new SpeechSynthesisUtterance(t);
            msg.onstart = () => {
                const obj = canvas.getActiveObject();
                if(obj) obj.animate('scaleY', 0.45, { duration: 200, onChange: canvas.renderAll.bind(canvas), onComplete: () => obj.animate('scaleY', 0.4, { duration: 200, onChange: canvas.renderAll.bind(canvas)}) });
            };
            window.speechSynthesis.speak(msg);
        }

        function playPreview() {
            save(); document.getElementById('preview-layer').style.display = 'flex';
            let i = 0;
            const timer = setInterval(() => {
                if(i >= frames.length) { clearInterval(timer); }
                else { pCanvas.loadFromJSON(frames[i], () => pCanvas.renderAll()); i++; }
            }, 1000);
            window.lastTimer = timer;
        }

        function closePreview() { clearInterval(window.lastTimer); document.getElementById('preview-layer').style.display = 'none'; }
    </script>
</body>
</html>
