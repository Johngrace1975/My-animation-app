<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TweenCraft Ultra - Moods & AI Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --primary: #ff9f43; --purple: #9b59b6; --bg: #0a0a0a; --card: #1e1e1e; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #studio-screen { display: flex; flex-direction: column; height: 100vh; }
        .main-workspace { display: flex; flex-grow: 1; position: relative; }
        
        /* SIDEBAR */
        .side-toolbar { width: 70px; background: #141414; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 15px; border-right: 1px solid #333; }
        .tool-btn { width: 45px; height: 45px; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; border: 1px solid #444; }

        /* CANVAS */
        #canvas-wrapper { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #111; }
        
        /* MOOD MENU (New!) */
        .mood-menu { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.95); padding: 10px; border-radius: 15px; display: none; gap: 10px; border: 1px solid #444; z-index: 100; }
        .mood-btn { padding: 8px 15px; background: #333; border-radius: 10px; cursor: pointer; font-size: 12px; }
        .mood-btn:hover { background: var(--primary); }

        /* AI SCRIPT BOX */
        .ai-script-container { position: absolute; bottom: 80px; width: 80%; display: flex; gap: 10px; z-index: 10; }
        #ai-input { flex-grow: 1; background: var(--card); border: 1px solid var(--purple); border-radius: 10px; color: white; padding: 10px; }

        /* TIMELINE */
        .timeline { height: 70px; background: #181818; display: flex; align-items: center; padding: 0 20px; gap: 10px; border-top: 1px solid #333; }
        .frame-thumb { width: 60px; height: 40px; background: #444; border-radius: 5px; border: 2px solid transparent; cursor: pointer; }
        .frame-thumb.active { border-color: var(--primary); }
    </style>
</head>
<body>

    <div id="studio-screen">
        <div class="main-workspace">
            <div class="side-toolbar">
                <div class="tool-btn" onclick="addChar()">üë¶</div>
                <div class="tool-btn" onclick="toggleMoodMenu()">üé≠</div>
                <div class="tool-btn" onclick="location.reload()">üè†</div>
            </div>

            <div id="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>

            <div class="mood-menu" id="moodMenu">
                <div class="mood-btn" onclick="applyMood('Normal')">üôÇ Normal</div>
                <div class="mood-btn" onclick="applyMood('Happy')">üòÅ Happy</div>
                <div class="mood-btn" onclick="applyMood('Angry')">üò° Angry</div>
                <div class="mood-btn" onclick="applyMood('Sad')">üò¢ Sad</div>
            </div>

            <div class="ai-script-container">
                <input type="text" id="ai-input" placeholder="Type script for Lip Sync...">
                <button class="tool-btn" style="background:var(--purple); width:100px; font-size:14px;" onclick="runLipSync()">Generate</button>
            </div>
        </div>

        <div class="timeline" id="timeline">
            <div class="frame-thumb active" id="f-0" onclick="switchFrame(0)"></div>
            <div class="tool-btn" style="width:40px; height:40px;" onclick="addNewFrame()">+</div>
        </div>
    </div>

    <script>
        const canvas = new fabric.Canvas('mainCanvas');
        let frames = [];
        let currentFrameIndex = 0;

        window.onload = () => {
            canvas.setDimensions({ width: 800, height: 450 });
            canvas.backgroundColor = "#222";
            saveFrame();
        };

        function toggleMoodMenu() {
            const menu = document.getElementById('moodMenu');
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
        }

        function applyMood(mood) {
            const active = canvas.getActiveObject();
            if (!active) return alert("Select character first!");
            
            // Logic to change expression visual (using filters or color shifts for demo)
            if(mood === 'Angry') active.filters = [new fabric.Image.filters.BlendColor({color: '#ff0000', mode: 'multiply', alpha: 0.3})];
            else if(mood === 'Sad') active.filters = [new fabric.Image.filters.BlendColor({color: '#0000ff', mode: 'multiply', alpha: 0.2})];
            else active.filters = [];
            
            active.applyFilters();
            canvas.renderAll();
            saveFrame();
            toggleMoodMenu();
        }

        function runLipSync() {
            const txt = document.getElementById('ai-input').value;
            const active = canvas.getActiveObject();
            if(!active) return;

            const msg = new SpeechSynthesisUtterance(txt);
            msg.onstart = () => {
                // Lip Sync Animation (Bouncing/Scaling)
                active.animate('scaleY', 0.45, { duration: 150, onChange: canvas.renderAll.bind(canvas),
                    onComplete: () => active.animate('scaleY', 0.4, { duration: 150, onChange: canvas.renderAll.bind(canvas) })
                });
            };
            window.speechSynthesis.speak(msg);
        }

        function saveFrame() { frames[currentFrameIndex] = JSON.stringify(canvas); }

        function addNewFrame() {
            saveFrame();
            currentFrameIndex = frames.length;
            const thumb = document.createElement('div');
            thumb.className = 'frame-thumb';
            thumb.id = `f-${currentFrameIndex}`;
            thumb.onclick = () => switchFrame(currentFrameIndex);
            document.getElementById('timeline').insertBefore(thumb, document.getElementById('timeline').lastElementChild);
            switchFrame(currentFrameIndex);
        }

        function switchFrame(index) {
            saveFrame();
            currentFrameIndex = index;
            document.querySelectorAll('.frame-thumb').forEach(t => t.classList.remove('active'));
            document.getElementById(`f-${index}`).classList.add('active');
            canvas.loadFromJSON(frames[index] || '{}', () => {
                canvas.backgroundColor = "#222";
                canvas.renderAll();
            });
        }

        function addChar() {
            fabric.Image.fromURL('https://cdn-icons-png.flaticon.com/512/4333/4333609.png', img => {
                img.set({ scaleX: 0.4, scaleY: 0.4, left: 100, top: canvas.height, originY: 'bottom' });
                canvas.add(img); saveFrame();
            }, { crossOrigin: 'anonymous' });
        }
    </script>
</body>
</html>
