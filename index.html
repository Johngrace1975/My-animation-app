<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TweenCraft Ultra - AI Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --primary: #ff9f43; --bg: #0a0a0a; --card: #1e1e1e; --blue: #3498db; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        /* BG SELECTION GRID */
        .bg-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; max-width: 600px; }
        .bg-item { background: var(--card); border-radius: 15px; overflow: hidden; border: 3px solid transparent; cursor: pointer; text-align: center; transition: 0.2s; }
        .bg-item:hover { border-color: var(--primary); transform: scale(1.05); }
        .bg-thumb { width: 100%; height: 80px; object-fit: cover; background: #333; }
        .bg-label { font-size: 12px; padding: 5px; color: #bbb; }

        /* STUDIO UI */
        #studio-screen { flex-direction: row; }
        .side-toolbar { width: 70px; background: rgba(20,20,20,0.95); height: 100%; display: flex; flex-direction: column; gap: 20px; align-items: center; padding-top: 20px; border-right: 1px solid #333; }
        .tool-btn { width: 50px; height: 50px; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; }
        .magic-ai-btn { background: linear-gradient(45deg, #9b59b6, #3498db); border: none; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        
        #canvas-wrapper { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        canvas { box-shadow: 0 0 30px rgba(0,0,0,0.8); border: 1px solid #444; }

        .bottom-bar { position: absolute; bottom: 20px; display: flex; gap: 15px; align-items: center; }
        .rec-circle { width: 60px; height: 60px; background: #e74c3c; border: 4px solid white; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

    <div id="bg-screen" class="screen active">
        <h2 style="margin-bottom: 5px;">Choose a scene</h2>
        <button class="magic-ai-btn" onclick="aiAutoGenerate()">‚ú® AI Video Creator (Auto-Setup)</button>
        
        <div class="bg-grid">
            <div class="bg-item" onclick="startWithBG('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400')">
                <img class="bg-thumb" src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=200">
                <div class="bg-label">Beach</div>
            </div>
            <div class="bg-item" onclick="startWithBG('https://images.unsplash.com/photo-1497366216548-37526070297c?w=400')">
                <img class="bg-thumb" src="https://images.unsplash.com/photo-1497366216548-37526070297c?w=200">
                <div class="bg-label">Office</div>
            </div>
            <div class="bg-item" onclick="startWithBG('https://images.unsplash.com/photo-1517733925043-473a941914ec?w=400')">
                <img class="bg-thumb" src="https://images.unsplash.com/photo-1517733925043-473a941914ec?w=200">
                <div class="bg-label">City</div>
            </div>
        </div>
        <p style="color: gray; font-size: 12px;">Select a scene to enter the Manual Editor</p>
    </div>

    <div id="studio-screen" class="screen">
        <div class="side-toolbar">
            <div class="tool-btn" onclick="addChar('https://cdn-icons-png.flaticon.com/512/4333/4333609.png')">üë¶</div>
            <div class="tool-btn" onclick="addChar('https://cdn-icons-png.flaticon.com/512/4140/4140047.png')">üëß</div>
            <div class="tool-btn" onclick="addBubble()">üí¨</div>
            <div class="tool-btn" style="background:#e67e22" onclick="showScreen('bg-screen')">üèûÔ∏è</div>
        </div>

        <div id="canvas-wrapper">
            <canvas id="mainStage"></canvas>
            
            <div class="bottom-bar">
                <div class="rec-circle" id="recBtn" onclick="handleRec()"></div>
                <button class="magic-ai-btn" style="background:var(--blue)" onclick="downloadVid()">Export</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = new fabric.Canvas('mainStage');
        let recording = false, frames = [];

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- AI AUTO-GENERATE (THE "ONE-TAP" CHOICE) ---
        function aiAutoGenerate() {
            startWithBG('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800'); // Beach
            // Automatically add two characters facing each other
            setTimeout(() => {
                addChar('https://cdn-icons-png.flaticon.com/512/4333/4333609.png', 150);
                addChar('https://cdn-icons-png.flaticon.com/512/4140/4140047.png', 450);
                addBubble("AI Generated Story: Hello!");
            }, 500);
        }

        function startWithBG(url) {
            showScreen('studio-screen');
            canvas.setDimensions({ width: 800, height: 450 });
            fabric.Image.fromURL(url, img => {
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                    scaleX: canvas.width / img.width, scaleY: canvas.height / img.height
                });
            }, { crossOrigin: 'anonymous' });
        }

        function addChar(url, customLeft) {
            fabric.Image.fromURL(url, img => {
                img.set({ scaleX: 0.3, scaleY: 0.3, left: customLeft || 100, top: canvas.height, originY: 'bottom' });
                canvas.add(img);
                canvas.setActiveObject(img);
            }, { crossOrigin: 'anonymous' });
        }

        function addBubble(text = "Tap to edit") {
            const t = new fabric.IText(text, { fontSize: 22, left: 200, top: 100, backgroundColor: 'white', padding: 10, borderRadius: 10 });
            canvas.add(t);
        }

        // --- RECORDING & EXPORT ---
        function handleRec() {
            recording = !recording;
            document.getElementById('recBtn').style.borderRadius = recording ? "10px" : "50%";
            if(recording) {
                frames = [];
                recInterval = setInterval(() => frames.push(JSON.stringify(canvas)), 100);
            } else clearInterval(recInterval);
        }

        async function downloadVid() {
            const stream = document.querySelector('canvas').captureStream(30);
            const recorder = new MediaRecorder(stream);
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob(chunks));
                a.download = 'tweencraft_ai_video.webm'; a.click();
            };
            recorder.start();
            let i = 0;
            const play = setInterval(() => {
                if(i >= frames.length) { recorder.stop(); clearInterval(play); }
                else { canvas.loadFromJSON(frames[i], () => canvas.renderAll()); i++; }
            }, 100);
        }
    </script>
</body>
</html>
