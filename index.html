<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cartoon Movie Maker Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --accent: #ff9f43; --bg: #0a0a0a; --panel: #1a1a1a; --text: #f0f0f0; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }

        /* STUDIO LAYOUT */
        #studio-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .header { height: 50px; background: #111; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #333; }
        .export-btn { background: var(--accent); color: black; border: none; padding: 6px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        .main-editor { display: flex; flex-grow: 1; position: relative; }
        
        /* LEFT TOOLS */
        .sidebar { width: 70px; background: #141414; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; border-right: 1px solid #333; }
        .tool-btn { width: 48px; height: 48px; background: #252525; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; border: 1px solid #444; }

        /* CANVAS AREA */
        #canvas-wrap { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #000; }
        canvas { box-shadow: 0 0 30px rgba(0,0,0,0.5); border-radius: 4px; }

        /* BOTTOM UI */
        .bottom-panel { height: 160px; background: #181818; border-top: 1px solid #333; display: flex; flex-direction: column; }
        
        .audio-bar { height: 60px; display: flex; align-items: center; padding: 0 20px; gap: 15px; background: #111; border-bottom: 1px solid #222; }
        .audio-item { background: #333; border: none; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        .timeline-scroll { flex-grow: 1; display: flex; align-items: center; padding: 0 20px; gap: 15px; overflow-x: auto; }
        .thumb { width: 85px; height: 50px; background: #222; border-radius: 8px; border: 2px solid transparent; flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .thumb.active { border-color: var(--accent); }
        .btn-plus { width: 45px; height: 45px; background: var(--accent); color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; flex-shrink: 0; }
    </style>
</head>
<body>

    <div id="studio-container">
        <div class="header">
            <span style="font-weight: bold; letter-spacing: 1px;">CARTOON STUDIO</span>
            <button class="export-btn" onclick="exportVideo()">EXPORT MP4</button>
        </div>

        <div class="main-editor">
            <div class="sidebar">
                <div class="tool-btn" onclick="addChar()">üë¶</div>
                <div class="tool-btn" onclick="addText()">üí¨</div>
                <div class="tool-btn" style="color: #3498db;" onclick="location.reload()">üè†</div>
            </div>
            <div id="canvas-wrap">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>

        <div class="bottom-panel">
            <div class="audio-bar">
                <button class="audio-item" style="background: #e74c3c;">üéôÔ∏è Record Voice</button>
                <button class="audio-item" onclick="document.getElementById('fileIn').click()">üì§ Upload Audio</button>
                <button class="audio-item" style="background: #9b59b6;" onclick="runSpeech()">‚ú® AI Voice</button>
                <input type="file" id="fileIn" hidden accept="audio/*">
            </div>
            <div class="timeline-scroll" id="timeline">
                <div class="thumb active" id="frame-0" onclick="loadFrame(0)"></div>
                <div class="btn-plus" onclick="createFrame()">+</div>
            </div>
        </div>
    </div>

    <script>
        const canvas = new fabric.Canvas('mainCanvas');
        let frames = [];
        let currentIdx = 0;

        window.onload = () => {
            canvas.setDimensions({ width: 800, height: 450 });
            canvas.backgroundColor = "#222";
            // Load a default background
            fabric.Image.fromURL('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800', img => {
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), { scaleX: 800/img.width, scaleY: 450/img.height });
                saveFrame();
            }, { crossOrigin: 'anonymous' });
        };

        function saveFrame() { frames[currentIdx] = JSON.stringify(canvas); }

        function createFrame() {
            saveFrame();
            currentIdx = frames.length;
            const t = document.createElement('div');
            t.className = 'thumb'; t.id = `frame-${currentIdx}`;
            t.onclick = () => loadFrame(currentIdx);
            document.getElementById('timeline').insertBefore(t, document.querySelector('.btn-plus'));
            loadFrame(currentIdx);
        }

        function loadFrame(idx) {
            saveFrame();
            currentIdx = idx;
            document.querySelectorAll('.thumb').forEach(el => el.classList.remove('active'));
            document.getElementById(`frame-${idx}`).classList.add('active');
            canvas.loadFromJSON(frames[idx] || '{}', () => canvas.renderAll());
        }

        function addChar() {
            fabric.Image.fromURL('https://cdn-icons-png.flaticon.com/512/4333/4333609.png', img => {
                img.set({ scaleX: 0.5, scaleY: 0.5, left: 150, top: 450, originY: 'bottom' });
                canvas.add(img);
            }, { crossOrigin: 'anonymous' });
        }

        function runSpeech() {
            const val = prompt("Enter character dialog:");
            if (val) {
                const speech = new SpeechSynthesisUtterance(val);
                speech.onstart = () => {
                    const active = canvas.getActiveObject();
                    if(active) active.animate('scaleY', 0.53, { duration: 200, onChange: canvas.renderAll.bind(canvas), onComplete: () => active.animate('scaleY', 0.5, { duration: 200, onChange: canvas.renderAll.bind(canvas)}) });
                };
                window.speechSynthesis.speak(speech);
            }
        }

        function exportVideo() {
            alert("Compiling " + frames.length + " frames into video. Your download will start shortly...");
            // In a real app, you would use a library like Whammy.js or RecordRTC here.
            // For now, we simulate the save process.
            const link = document.createElement('a');
            link.download = 'my-cartoon-movie.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
